using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Text;

namespace MalwareAnalysisGUI
{
    class PEFileTool : AnalysisEngineTool
    {

        const string EXE32Name = @"Resources\PEFile32.exe";
        const string EXE64Name = @"Resources\PEFile64.exe";

        private Process process;

        public PEFileTool()
        {
            this.Description = "PEFileTool";
            this.Result = String.Empty;
        }

        public override void Analyze(Sample s)
        {

            Console.WriteLine(s.FileName);

            RunTool(s, EXE32Name);
            RunTool(s, EXE64Name);
        }

        private void RunTool(Sample s, String exeName)
        {
            ProcessStartInfo psi = new ProcessStartInfo();
            psi.Arguments = s.FullPath;
            psi.FileName = exeName;
            psi.UseShellExecute = false;
            psi.RedirectStandardOutput = true;

            process = Process.Start(psi);

            StringBuilder sb = new StringBuilder();
            while (process.HasExited == false)
            {
                sb.Append(process.StandardOutput.ReadToEnd());
            }

            sb.Append(process.StandardOutput.ReadToEnd());

            this.Result = String.Join(this.Result, sb.ToString());
        }

        public override void Dispose()
        {
            try
            {
                process.Kill();
            }
            catch (Exception)
            {

            }
        }
    }
}
